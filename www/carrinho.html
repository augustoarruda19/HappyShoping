<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
  <title>Meu Carrinho</title>

  <link rel="stylesheet" href="lib/framework7-bundle.min.css" />
  <link rel="stylesheet" href="css/materialdesignicons.min.css" />
  <link rel="stylesheet" href="css/remixicon/remixicon.css" />

  <style>
    body { background:#f8f8f8; font-family: "Poppins", sans-serif; margin:0; padding:0; }
    .nav-top { display:flex; align-items:center; justify-content:space-between; padding:15px 20px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.08); }
    .nav-top strong { font-size:18px; display:flex; align-items:center; gap:6px; }
    #carrinho-container { padding:10px 6px; }
    .cart-item { background:#fff; border-radius:14px; margin:10px 6px; padding:12px; display:flex; align-items:center; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    .cart-item img { width:80px; height:80px; border-radius:10px; object-fit:cover; margin-right:12px; }
    .item-info { flex:1; }
    .item-info h4 { margin:0; font-size:16px; color:#333; }
    .item-info p { margin:4px 0; color:#666; font-size:14px; }
    .price { color:#fa7304; font-weight:bold; font-size:15px; margin-top:4px; }
    .quantity-control { display:flex; align-items:center; gap:8px; margin-top:8px; }
    .quantity-control button { width:30px; height:30px; border-radius:50%; border:none; background:#fa7304; color:white; font-size:18px; cursor:pointer; }
    .cart-summary { background:#fff; margin:12px; border-radius:14px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    .summary-line { display:flex; justify-content:space-between; margin-bottom:8px; font-size:15px; }
    .checkout-btn { display:block; width:90%; margin:14px auto; background:#fa7304; color:#fff; border:none; border-radius:30px; padding:14px; font-size:16px; font-weight:700; cursor:pointer; box-shadow:0 4px 10px rgba(250,115,4,0.2); }
    .ri-delete-bin-line { cursor:pointer; color:#fa7304; font-size:20px; padding-left:10px; }
  </style>
</head>
<body>

  <div class="nav-top">
    <a href="index.html"><i class="ri-arrow-left-s-line" style="font-size:24px;"></i></a>
    <strong><i class="ri-shopping-cart-2-line"></i> Meu Carrinho</strong>
    <span></span>
  </div>

  <div id="carrinho-container"></div>

  <div class="cart-summary">
    <div class="summary-line"><span>Subtotal</span><strong id="subtotal">R$ 0,00</strong></div>
    <div class="summary-line"><span>Taxa de entrega</span><strong id="delivery">R$ 5,00</strong></div>
    <div class="summary-line"><span>Desconto</span><strong id="discount">0%</strong></div>
  </div>

  <button class="checkout-btn" id="checkout">Finalizar compra</button>

  <script src="lib/jquery-3.7.0.min.js"></script>

  <script>
    const BASE = 'http://127.0.0.1:3000';

    function formatBR(val) {
      return Number(val).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function getUsuarioId() {
      const params = new URLSearchParams(window.location.search);
      const u = params.get('usuario_id') || localStorage.getItem('usuarioId') || '1';
      return u;
    }

    async function carregarCarrinho() {
      const usuarioId = getUsuarioId();
      try {
        const res = await fetch(`${BASE}/carrinho/${usuarioId}`);
        if (!res.ok) throw new Error('Erro ao buscar carrinho');
        const itens = await res.json();

        const container = document.getElementById('carrinho-container');
        container.innerHTML = '';
        let subtotal = 0;

        itens.forEach(item => {
          subtotal += (item.preco * item.quantidade);

          const div = document.createElement('div');
          div.className = 'cart-item';
          div.innerHTML = `
            <img src="${item.imagem || 'img/placeholder.png'}" alt="${item.nome}">
            <div class="item-info">
              <h4>${item.nome}</h4>
              <div class="price">${formatBR(item.preco)}</div>
              <div class="quantity-control">
                <button data-id="${item.id}" class="btn-decr">−</button>
                <span class="qtd">${item.quantidade}</span>
                <button data-id="${item.id}" class="btn-incr">+</button>
              </div>
            </div>
            <i class="ri-delete-bin-line" data-id="${item.id}"></i>
          `;
          container.appendChild(div);
        });

        document.getElementById('subtotal').innerText = formatBR(subtotal);

        document.querySelectorAll('.btn-decr').forEach(b => b.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const current = Number(e.currentTarget.nextElementSibling.textContent);
          const nova = current - 1;
          if (nova < 1) {
            if (!confirm('Remover item do carrinho?')) return;
            await removerItem(id);
          } else {
            await alterarQuantidade(id, nova);
          }
        }));

        document.querySelectorAll('.btn-incr').forEach(b => b.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          const current = Number(e.currentTarget.previousElementSibling.textContent);
          const nova = current + 1;
          await alterarQuantidade(id, nova);
        }));

        document.querySelectorAll('.ri-delete-bin-line').forEach(el => el.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          if (!confirm('Remover este item do carrinho?')) return;
          await removerItem(id);
        }));
      } catch (err) {
        console.error('Erro ao carregar carrinho:', err);
      }
    }

    async function alterarQuantidade(id, novaQtd) {
      await fetch(`${BASE}/carrinho/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantidade: novaQtd })
      });
      carregarCarrinho();
    }

    async function removerItem(id) {
      await fetch(`${BASE}/carrinho/${id}`, { method: 'DELETE' });
      carregarCarrinho();
    }

    // ------------------------
    // FINALIZAR COMPRA (NOVA PARTE)
    // ------------------------
    document.getElementById('checkout').addEventListener('click', async () => {
      const usuarioId = getUsuarioId();

      try {
        const itensRes = await fetch(`${BASE}/carrinho/${usuarioId}`);
        const itens = await itensRes.json();

        if (itens.length === 0) {
          alert("Seu carrinho está vazio!");
          return;
        }

        const valorTotal = itens.reduce((acc, item) => acc + (item.preco * item.quantidade), 0);

        const pedidoRes = await fetch(`${BASE}/pedidos`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            usuario_id: usuarioId,
            valor_total: valorTotal,
            itens: itens
          })
        });

        if (!pedidoRes.ok) {
          alert("Erro ao finalizar compra!");
          return;
        }

        await fetch(`${BASE}/carrinho/usuario/${usuarioId}`, { method: 'DELETE' });

        alert("Compra finalizada com sucesso!");
        carregarCarrinho();

      } catch (err) {
        console.error(err);
        alert("Erro ao processar pedido.");
      }
    });

    document.addEventListener('DOMContentLoaded', carregarCarrinho);
  </script>
</body>
</html>
