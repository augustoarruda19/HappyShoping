<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#2196f3">
  <title>HappyShopping</title>

  <!-- Framework7 e estilos -->
  <link rel="stylesheet" href="lib/framework7-bundle.min.css">
  <link rel="stylesheet" href="css/index.css">
  <link rel="stylesheet" href="css/detalhes.css">
  <link rel="stylesheet" href="css/carrinho.css">
  <link rel="stylesheet" href="css/materialdesignicons.min.css">
  <link rel="stylesheet" href="css/remixicon/remixicon.css">
</head>

<body>
  <div id="app">
    <div class="view view-main">

      <!-- Barra inferior -->
      <div class="toolbar toolbar-bottom">
        <div class="toolbar-inner display-flex">
          <a href="/index/" class="tab-link link active">
            <i class="ri-home-4-fill"></i>
            <span>Home</span>
          </a>
          <a href="/link2/" class="tab-link link">
            <i class="ri-search-line"></i>
            <span>Busca</span>
          </a>
          <a href="/link3/" class="tab-link link">
            <i class="ri-heart-fill"></i>
            <span>Favoritos</span>
          </a>
          <a href="/link4/" class="tab-link link">
            <i class="ri-user-3-fill"></i>
            <span>Conta</span>
          </a>
        </div>
      </div>

      <!-- Página principal -->
      <div data-name="index" class="page color-theme-blue">

        <!-- Topo -->
        <div class="top-nav">
          <h1 class="tittle-logo">H<span>app</span>yShopping</h1>
          <a href="#" class="btn-cart" data-count="0">
            <i class="ri-shopping-bag-4-fill"></i>
          </a>
        </div>

        <form>
          <input placeholder="O que você procura?" type="text" class="search-box">
          <i class="icone-busca ri-search-line"></i>
        </form>

        <!-- Conteúdo -->
        <div class="page-content">
          <div class="block no-margin-top">
            <!-- Swiper -->
            <div class="swiper mySwiper">
              <div class="swiper-wrapper">
                <div class="swiper-slide"><img src="img/propaganda.png"></div>
                <div class="swiper-slide"><img src="img/propaganda2.png"></div>
                <div class="swiper-slide"><img src="img/propaganda3.png"></div>
                <div class="swiper-slide"><img src="img/propaganda4.png"></div>
              </div>
            </div>

            <!-- Categorias -->
            <div class="display-flex align-items-center justify-content-space-between">
              <h2>Categorias</h2>
              <a href="#">Ver todas<i class="mdi mdi-arrow-right"></i></a>
            </div>

            <div class="swiper categorias">
              <div class="swiper-wrapper">
                <div class="swiper-slide"><button class="filter-btn active">Todas</button></div>
                <div class="swiper-slide"><button class="filter-btn">Celulares</button></div>
                <div class="swiper-slide"><button class="filter-btn">Eletrônicos</button></div>
                <div class="swiper-slide"><button class="filter-btn">Informática</button></div>
                <div class="swiper-slide"><button class="filter-btn">Acessórios</button></div>
                <div class="swiper-slide"><button class="filter-btn">Moda</button></div>
                <div class="swiper-slide"><button class="filter-btn">Calçados</button></div>
                <div class="swiper-slide"><button class="filter-btn">Casa</button></div>
                <div class="swiper-slide"><button class="filter-btn">Cozinha</button></div>
                <div class="swiper-slide"><button class="filter-btn">Eletrodomésticos</button></div>
                <div class="swiper-slide"><button class="filter-btn">Ferramentas</button></div>
                <div class="swiper-slide"><button class="filter-btn">Esportes</button></div>
                <div class="swiper-slide"><button class="filter-btn">Brinquedos</button></div>
                <div class="swiper-slide"><button class="filter-btn">Bebês</button></div>
                <div class="swiper-slide"><button class="filter-btn">Beleza</button></div>
                <div class="swiper-slide"><button class="filter-btn">Saúde</button></div>
                <div class="swiper-slide"><button class="filter-btn">Automotivo</button></div>
                <div class="swiper-slide"><button class="filter-btn">Jardinagem</button></div>
                <div class="swiper-slide"><button class="filter-btn">Pets</button></div>
                <div class="swiper-slide"><button class="filter-btn">Livros</button></div>
                <div class="swiper-slide"><button class="filter-btn">Música</button></div>
              </div>
            </div>

            <!-- Produtos -->
            <div id="produtos" class="row display-flex align-items-center justify-content-bet">
              <p style="color: gray;">Carregando produtos...</p>
            </div>

            <!-- Botão de cadastro -->
            <button id="btnCadastrarProduto" class="botao-cadastro">
              Cadastrar Novo Produto
            </button>

            <br><br><br><br><br><br><br><br>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="lib/framework7-bundle.min.js"></script>
  <script src="lib/jquery-3.7.0.min.js"></script>
  <script src="js/routes.js"></script>
  <script src="cordova.js"></script>

  <!-- Redirecionamento para cadastro -->
  <script>
    document.getElementById('btnCadastrarProduto').addEventListener('click', () => {
      window.location.href = "cadastro-produtos.html";
    });
  </script>

  <!-- Carregamento de produtos do MySQL -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const container = document.getElementById('produtos');
      try {
        const res = await fetch('http://127.0.0.1:3000/produtos');
        const produtos = await res.json();

        container.innerHTML = ''; // limpa o "Carregando..."
        produtos.forEach(produto => {
          const card = document.createElement('div');
          card.classList.add('item-card');

          card.innerHTML = `
            <div class="item" data-id="${produto.id}">
              <div class="img-container">
                <img src="${produto.imagem || 'img/placeholder.png'}" alt="${produto.nome}">
              </div>
              <div class="info-container">
                <div class="nome">${produto.nome}</div>
                <div class="avaliacao">
                  <i class="mdi mdi-star"></i>
                  <span>4.5</span>
                </div>
              </div>
              <div class="price">${Number(produto.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</div>
            </div>
          `;

          card.querySelector('.item').addEventListener('click', () => {
            window.location.href = `detalhes.html?id=${produto.id}`;
          });

          container.appendChild(card);
        });

      } catch (err) {
        console.error('Erro ao carregar produtos:', err);
        container.innerHTML = '<p style="color:red;">Erro ao carregar produtos.</p>';
      }
    });
  </script>

  <script>
    // Garante que cada card gerado tenha as classes internas que o CSS espera:
    (function normalizeProductCards() {
      const container = document.getElementById('produtos');
      if (!container) return;
      const observer = new MutationObserver(() => {
        container.querySelectorAll('.item-card').forEach(card => {
          const link = card.querySelector('a.item');
          if (!link) return;
          let imgC = card.querySelector('.img-container');
          if (!imgC) {
            const ic = link.querySelector('.img-container') || link.querySelector('img');
            if (ic) {
              imgC = document.createElement('div');
              imgC.className = 'img-container';
              const img = link.querySelector('img');
              if (img) imgC.appendChild(img);
              card.insertBefore(imgC, card.firstChild);
            }
          }
          let info = card.querySelector('.info-container');
          if (!info) {
            info = document.createElement('div');
            info.className = 'info-container';
            const nome = document.createElement('div');
            nome.className = 'nome';
            const spanNome = link.querySelector('.nome-rating span') || link.querySelector('span');
            nome.textContent = spanNome ? spanNome.textContent.trim() : (link.getAttribute('data-name') || '');
            const aval = document.createElement('div');
            aval.className = 'avaliacao';
            const star = document.createElement('i');
            star.className = 'mdi mdi-star';
            aval.appendChild(star);
            const score = document.createElement('span');
            score.textContent = link.querySelector('.nome-rating span:nth-child(2)') ? link.querySelector('.nome-rating span:nth-child(2)').textContent.trim() : '4.5';
            aval.appendChild(score);
            info.appendChild(nome);
            info.appendChild(aval);
            const after = card.querySelector('.img-container') ? card.querySelector('.img-container').nextSibling : card.firstChild;
            card.insertBefore(info, after);
          }
          let price = card.querySelector('.price');
          if (!price) {
            const p = document.createElement('div');
            p.className = 'price';
            const priceText = link.querySelector('.price') ? link.querySelector('.price').textContent.trim() : '';
            p.textContent = priceText;
            card.appendChild(p);
          }
        });
      });
      observer.observe(container, { childList: true, subtree: true });
      observer.takeRecords();
      observer.disconnect();
    })();
  </script>

</body>
</html>
